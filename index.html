<html>
    <head>
        <title>Masked Categorisation Task</title>
    	<meta charset="utf-8"/>
        <!-- pull in jsPsych resources -->
        <script src="jspsych-6.3.1/jspsych.js"></script>
        <script src="jspsych-6.3.1/plugins/jspsych-image-button-response.js"></script>
        <script src="jspsych-6.3.1/plugins/jspsych-html-button-response.js"></script>
        <script src="jspsych-6.3.1/plugins/jspsych-html-keyboard-response.js"></script>
        <!-- pull in experiment resources -->
        <script src="lib/consent.js"></script>
        <script src="lib/demographics.js"></script>
        <script src="lib/helperFunctions.js"></script>
        <!-- some additional styling to make the background black -->
        <link href="lib/exp.css" rel="stylesheet" type="text/css"></link>
        <style></style>
    </head>
    <body></body>
    <script>

        console.log("starting experiment");

        ///////////////////
        /* set up params */
        ///////////////////

        var fixation_time = 200; // ms to display fixation
        var stimulus_display_time = 50; // ms to display trial
        var stimulus_blank_time = 30; // ms to display blank screen after stimulus
        var mask_time = 80; // ms to display mask
        var response_time = 2000; // max time for participant response

        var stimulus_difficulty = {
            valid: [1,2,3,4,5], // valid stimulus difficulties, should correspond to folder names
            default: 3, // default stim difficulty (used for first trials to establish accuracy)
            min: 1, // min stimulus difficulty (to limit titration from going too far down)
            max: 5, // max stimulus difficulty (to limit titration from going too far up)
            method: 'accuracy', // determined by 'accuracy' or 'specified'
            accuracy: 50, // if accuracy, percentage difficulty to titrate to
            history: 4, // if accuracy, number of trials to check accuracy over
            repetitions: 10, // if specified, number of times to present each stimulus difficulty per image type
            order: [] // generate this later
        };

        var stimuli = {
            labels: [ // should be equal to image category and category folder name, used as response prompt name also
                'car',
                'elephant',
                'fish',
                'hammer',
                'hand_blower',
                'hat',
                'iron',
                'ladybug',
                'pineapple',
                'pot',
                'sewing_machine',
                'violin',
            ],
            exemplars: 16, // quantity of exemplars of each category
            quantity: 100, // quantity of variants of each image exemplar
            category_order: [], // we'll generate this later
            variant_order: [], // generate later
            exemplar_order: [], //generate this later
            stimuli_paths: [], // generate this later for preloading images
            mask_paths: [], // generate for later
            prompt_paths:  [], // generate this later for preloading images
            prompt_order: [], // generate this later
            prompt_html_array: [] // generate this later
        };
        stimuli.accuracy = stimuli.labels.map( // new array mapped to the length of stimuli.labels
            () => { return 50; } // with each value the return value of this function
        ); // an accuracy for each stimulus to be set to chance and updated per trial


        ////////////////////////////////
        /* generate trial information */
        ////////////////////////////////

        
        console.log("generate trial information");

        // let's generate some trial information
        for (i=0; i < stimuli.labels.length; i++) {

            // create array of stimulus difficulties valid*repetitions*imagetype
            for (reps = 0; reps < stimulus_difficulty.repetitions; reps++) {
                stimulus_difficulty.order = stimulus_difficulty.order.concat(stimulus_difficulty.valid);
            }
            // we'll probably want to counterbalance these

            // create array of indices for response prompt order - again will probably counter balance these
            stimuli.prompt_order = stimuli.prompt_order.concat(i);
            // create some html image tags with stimulus paths for the response prompts
            // we don't want images, just the words, so we won't use this
            //stimuli.prompt_html_array = stimuli.prompt_html_array.concat('<img src="' + stimulusPathFactory(stimuli.labels[i],null,null,'prompt') + '" class="response-img"/>');
            // we want these to preload the images
            //stimuli.prompt_paths = stimuli.prompt_paths.concat(stimulusPathFactory(stimuli.labels[i],null,null,'prompt'));

            // now we loop through the number of exempars
            for (exemplar = 0; exemplar < stimuli.exemplars; exemplar++) {
                exemplarMod = exemplar+1; // add one because js starts at 0

                // we want these to preload the images
                stimuli.mask_paths = stimuli.mask_paths.concat(stimulusPathFactory(stimuli.labels[i],exemplarMod.toString(),null,null,'mask'));

                for (rep = 0; rep < stimuli.quantity; rep++) {
                    // generate array of indices for stimuli.labels*quantity
                    stimuli.category_order = stimuli.category_order.concat(i);
                    stimuli.variant_order = stimuli.variant_order.concat(rep+1); // plus one because js starts at 0
                    stimuli.exemplar_order = stimuli.exemplar_order.concat(exemplar+1);
                    for (diff = 0; diff < stimulus_difficulty.valid.length; diff++) {
                        diffMod = diff+1; // add one because js starts at 0
                        repMod = rep+1; // add one because js starts at 0
                        // generate these to preload the images
                        stimuli.stimuli_paths = stimuli.stimuli_paths.concat(stimulusPathFactory(stimuli.labels[i],exemplarMod.toString(),repMod.toString(),diffMod.toString(),'stimulus'));
                    }
                }
            }
        }
        // we'll probably want to counterbalance:
        // stimuli.prompt_order and stimuli.prompt_html_array need to be changed in the same way
        // stimuli.category_order and stimuli.variant_html_array need to be changed in the same way

        ////////////////////////////
        /* jsPsych trial settings */
        ////////////////////////////

        console.log("generate trial settings");

        // we'll reuse this as a fixation - shows a cross on the screen. can be changed
        var fixation = {
            type: 'html-keyboard-response',
            stimulus: '<p style="font-size: 48px;">+</p>',
            choices: jsPsych.NO_KEYS,
            trial_duration: fixation_time,
            data: {experiment_part: 'fixation'} // we use this information to filter trials
        };

        var random_mask = {
            type: 'image-button-response',
            // stimulus: 'stimuli/mask_placeholder.png', // we generate this dynamically in the trial loop
            choices: stimuli.labels.concat('none of these','not sure'),
            stimulus_duration: mask_time,
            trial_duration: response_time,
            data: {experiment_part: 'response'} // we use this information to filter trials
        };

        var stimulus_presentation = {
            type: 'image-button-response',
            // stimulus: 'path/to/image', // we specify this dynamically in the trial loop
            choices: stimuli.labels.concat('none of these','not sure'),
            // choices: ['array','of','html','or','text','to','display'], // we'll make these html images
            stimulus_duration: stimulus_display_time,
            trial_duration: stimulus_display_time+stimulus_blank_time,
            prompt: "<p>Select Response</p>",
            data: {experiment_part: 'presentation'} // we use this information to filter trials
        };


        ////////////////////////////
        /* experiment constructor */
        ////////////////////////////

        console.log("construct experiment");

        /* initialise timeline array */

        var timeline = [];


        // choose a starting difficulty and declare as a global variable
        if (stimulus_difficulty.method === 'accuracy') {
            var thisDifficulty = stimulus_difficulty.default;
        } else if (stimulus_difficulty.method === 'specified') {
            var thisDifficulty = stimulus_difficulty.order[0];
        }

        /* commence generating trials */

        for (trial = 0; trial < stimuli.category_order.length; trial++) {
            if (stimulus_difficulty.method === 'accuracy' && trial < stimulus_difficulty.history) {
                // add enough trials to start checking history for accuracy
                timeline.push(
                    {...fixation,
                        data: {...fixation.data,
                            trial_num: trial
                        }
                    },
                    {...stimulus_presentation,
                        stimulus: function() {
                            console.log('using default difficulty to establish baseline');
                            return getStimulus(
                                jsPsych.data.get().last(1).values()[0].trial_num,
                                stimulus_difficulty.default
                            );
                        },
                    },
                    {...random_mask,
                        stimulus: function() {
                            return getMask(
                                jsPsych.data.get().last(2).values()[0].trial_num
                            );
                        },
                        on_finish: function(data) {
                            // code for correctness
                            var response = jsPsych.data.get().last(1).values()[0].response;
                            var stimulus_index = jsPsych.data.get().last(3).values()[0].trial_num;
                            if (stimuli.prompt_order[response] == stimuli.category_order[stimulus_index]) {
                                console.log('correct')
                                data.correct = true;
                            } else {
                                console.log('incorrect')
                                data.correct = false;
                            }
                            data.response_label = stimuli.labels[stimuli.prompt_order[stimulus_index]];
                            data.stimulus_label = stimuli.labels[stimuli.category_order[stimulus_index]];
                            data.stimulus_variant = stimuli.variant_order[stimulus_index];
                        }
                    },
                );
            } else {
                timeline.push(
                    {...fixation,
                        data: {...fixation.data,
                            trial_num: trial
                        }
                    },
                    {...stimulus_presentation,
                        stimulus: function() {
                            return getStimulus(
                                jsPsych.data.get().last(1).values()[0].trial_num, // use the index we specified in fixation
                                thisDifficulty
                            );
                        },
                    },
                    {...random_mask,
                        stimulus: function() {
                            return getMask(
                                jsPsych.data.get().last(2).values()[0].trial_num
                            );
                        },
                        on_finish: function(data) {
                            // code for correctness
                            var response = jsPsych.data.get().last(1).values()[0].response;
                            var stimulus_index = jsPsych.data.get().last(3).values()[0].trial_num;
                            if (stimuli.prompt_order[response] == stimuli.category_order[stimulus_index]) {
                                console.log('correct')
                                data.correct = true;
                            } else {
                                console.log('incorrect')
                                data.correct = false;
                            }
                            data.response_label = stimuli.labels[stimuli.prompt_order[stimulus_index]];
                            data.stimulus_label = stimuli.labels[stimuli.category_order[stimulus_index]];
                            data.stimulus_variant = stimuli.variant_order[stimulus_index];

                            // adjust difficulty
                            if (stimulus_difficulty.method === 'accuracy') {
                                thisDifficulty = difficultyTitration(thisDifficulty);
                            } else if (stimulus_difficulty.method === 'specified') {
                                thisDifficulty = stimulus_difficulty.order[stimulus_index+1];
                                console.log('next difficulty will be: ', thisDifficulty);
                            }
                        }
                    },
                );
            }
        }

        ////////////////////////
        /* initialise jsPsych */
        ////////////////////////

        console.log("initialise jsPsych");
    
        jsPsych.init({
            timeline: timeline,
            preload_images: [stimuli.stimuli_paths, stimuli.prompt_paths, stimuli.mask_paths],
            on_finish: function() {
                jsPsych.data.displayData();
            }
        });

    </script>
</html>
